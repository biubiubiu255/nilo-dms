<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nilo.dms.dao.HandleRiderDao">

    <!-- 实体bean与数据字段对应关系 -->
    <resultMap id="orderBig" type="com.nilo.dms.dao.dataobject.RiderDelivery">
        <result property="merchantId" column="merchant_id" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="handleNo" column="handle_no" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="handleBy" column="handle_by" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="rider" column="rider" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="nextStation" column="network_id" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="handle_time" column="handle_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="status" column="status" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="remark" column="remark" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="created_time" column="created_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="updated_time" column="updated_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
    </resultMap>

    <!-- 实体bean与数据字段对应关系 -->
    <resultMap id="orderSmall" type="com.nilo.dms.dao.dataobject.RiderDeliverySmallDO">
        <result property="merchantId" column="merchant_id" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="handleNo" column="handle_no" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="orderNo" column="order_no" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
<!--        <result property="handleByName" column="name" javaType="java.lang.String"
                jdbcType="VARCHAR"/>-->
        <result property="weight" column="weight" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="length" column="length" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="height" column="height" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="width" column="width" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="handleBy" column="handle_by" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="status" column="status" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="created_time" column="created_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="updated_time" column="updated_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="userInfoDO" type="com.nilo.dms.dao.dataobject.UserInfoDO">
        <result property="id" column="id" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="name" column="name" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="email" column="email" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="phone" column="phone" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="merchantId" column="merchant_id" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="createdTime" column="created_time" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="updatedTime" column="updated_time" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="version" column="version" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
    </resultMap>


    <!-- 查询装车打包 -->
    <select id="queryRiderDeliveryBig" resultMap="orderBig" statementType="PREPARED"  parameterType="com.nilo.dms.dao.dataobject.RiderDelivery">
        SELECT
        *
        FROM
        t_handle_rider
        WHERE 1
        <if test="ob.status != null">
            and status = #{ob.status}
        </if>
        <if test="ob.handleNo != null and ob.handleNo != '' ">
            and handle_no = #{ob.handleNo}
        </if>
        <if test="ob.rider != null and ob.rider != ''">
            and rider = #{ob.rider}
        </if>
        order by created_time desc

        limit #{offset} , #{limit}

    </select>

    <!-- 查询装车打包数量 -->
    <select id="queryRiderDeliveryBigCount" resultType="java.lang.Integer" statementType="PREPARED"  parameterType="com.nilo.dms.dao.dataobject.RiderDelivery">
        SELECT
        count(*)
        FROM
        t_handle_rider
        WHERE 1
        <if test="ob.status != null">
            and status = #{ob.status}
        </if>
        <if test="ob.handleNo != null and ob.handleNo != '' ">
            and handle_no = #{ob.handleNo}
        </if>
        <if test="ob.rider != null and ob.rider != ''">
            and rider = #{ob.rider}
        </if>
    </select>

    <insert id="insertBig" parameterType="com.nilo.dms.dao.dataobject.RiderDelivery"
            statementType="PREPARED" useGeneratedKeys="true" keyProperty="id">
        INSERT
        INTO t_handle_rider
        ( merchant_id, handle_no, rider, network_id, handle_time, handle_by, status, remark, created_time, updated_time)
        VALUES
        (
        #{merchantId},#{handleNo},#{rider},#{nextStation},UNIX_TIMESTAMP(NOW()),#{handleBy},#{status},#{remark},UNIX_TIMESTAMP(NOW()),UNIX_TIMESTAMP(NOW()))
    </insert>

    <update id="upBigStatus" statementType="PREPARED">
        update t_handle_rider
        SET
        status = #{status},
        updated_time=UNIX_TIMESTAMP(NOW()),
        version=UUID()
        WHERE
        handle_no = #{handleNo}
    </update>

    <update id="upBigBy" statementType="PREPARED" parameterType="com.nilo.dms.dao.dataobject.RiderDelivery">
        update t_handle_rider
        SET
        status = #{status},
        updated_time=UNIX_TIMESTAMP(NOW()),
        version=UUID()
        <if test="rider != null and rider != ''">
            , rider = ${rider}
        </if>

        <if test="remark != null and remark != ''">
            , remark = #{remark}
        </if>
        WHERE
        handle_no = #{handleNo}
    </update>



    <!-- 下面是子包分割线 -->
    <select id="queryDeliverySmall" resultMap="orderSmall" statementType="PREPARED" parameterType="com.nilo.dms.dao.dataobject.RiderDeliverySmallDO">
        SELECT
        *
        FROM
        t_handle_rider_details
        WHERE 1
        <if test="status != null">
            and status = #{status}
        </if>
        <if test="handleNo != null and handleNo != '' ">
            and handle_no = #{handleNo}
        </if>
        order by created_time desc
    </select>

    <insert id="insertSmall" parameterType="com.nilo.dms.dao.dataobject.RiderDeliverySmallDO"
            statementType="PREPARED" useGeneratedKeys="true" keyProperty="id">
        INSERT
        INTO
        t_handle_rider_details
        ( handle_no, order_no, weight, length, height, width, handle_by, status, created_time, updated_time )
        VALUES
        (#{handleNo},#{orderNo},#{weight},#{length},#{height},#{width},#{handleBy},#{status},UNIX_TIMESTAMP(NOW()),UNIX_TIMESTAMP(NOW()))
    </insert>


    <insert id="insertSmalls">
        INSERT
        INTO
        t_handle_rider_details
        ( handle_no, order_no, weight, length, height, width, handle_by, status, created_time, updated_time )
        VALUES
        <foreach collection="emps" item="emp" separator=",">
            (#{emp.handleNo},#{emp.orderNo},#{emp.weight},#{emp.length},#{emp.height},#{emp.width},#{emp.handleBy},#{emp.status},UNIX_TIMESTAMP(NOW()),UNIX_TIMESTAMP(NOW()))
        </foreach>

    </insert>

    <delete id="deleteSmallsByHandleNo">
        delete FROM t_handle_rider_details
        WHERE handle_no = #{handleNo}
    </delete>

    <!-- 查询其他的信息 -->

    <select id="queryUserInfoBySmallNo" resultMap="userInfoDO" statementType="PREPARED">
        SELECT

        c.*

        FROM

        t_handle_rider_details a

        INNER JOIN t_handle_rider b

        on a.handle_no = b.handle_no

        INNER JOIN t_sys_user_info c

        on b.rider = c.id

        WHERE a.order_no = #{orderNo}

        ORDER BY a.created_time DESC

        limit 1

    </select>


    <update id="upSmallStatus" statementType="PREPARED">
        update t_handle_rider_details
        SET
        status = #{status},
        updated_time=UNIX_TIMESTAMP(NOW()),
        version=UUID()
        WHERE
        handle_no = #{handleNo}
    </update>

    <delete id="deleteHandleBy">
        delete FROM t_handle_rider
        WHERE merchant_id = #{merchantId} and  handle_no = #{handleNo}
    </delete>

</mapper>