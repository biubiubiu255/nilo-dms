<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nilo.dms.dao.DeliverAgendaDao">

 <resultMap id="deliverReport" type="com.nilo.dms.dao.dataobject.DeliverAgendaDO">
     <result property="deliveredMonthNum" column="delivered_month_num" javaType="java.lang.Integer" jdbcType="INTEGER"/>
     <result property="deliveredDayNum" column="delivered_day_num" javaType="java.lang.Integer" jdbcType="INTEGER"/>
     <result property="taskDayNum" column="task_day_num" javaType="java.lang.Integer" jdbcType="INTEGER"/>
     <result property="delayDayNum" column="delay_day_num" javaType="java.lang.Integer" jdbcType="INTEGER"/>
     <result property="createdTime" column="created_time" javaType="java.lang.Long" jdbcType="INTEGER"/>
 </resultMap>

 <select id="queryReport" resultMap="deliverReport">

SELECT
	*, UNIX_TIMESTAMP() AS created_time
FROM
	(
		SELECT
			count(id) AS 'delivered_month_num'
		FROM
			t_handle_sign
		WHERE
			handle_by = #{riderNo}
		AND FROM_UNIXTIME(created_time, '%Y%m') = date_format(NOW(), '%Y%m')
	) AS a,
	(
		SELECT
			count(DISTINCT b.order_no) AS 'task_day_num'
		FROM
			t_handle_rider AS a
		INNER JOIN t_handle_rider_details AS b ON a.handle_no = b.handle_no
		AND a. STATUS = 1
		AND a.rider =  #{riderNo}
		AND FROM_UNIXTIME(b.created_time, '%Y%m%d') = #{dateFormat}
	) AS b,
	(
		SELECT
			count(*) AS delivered_day_num
		FROM
			(
				SELECT DISTINCT
					DISTINCT b.order_no
				FROM
					t_handle_rider AS a
				INNER JOIN t_handle_rider_details AS b ON a.handle_no = b.handle_no
				AND a. STATUS = 1
				AND a.rider = #{riderNo}
				AND FROM_UNIXTIME(b.created_time, '%Y%m%d') =  #{dateFormat}
			) AS d
		INNER JOIN t_handle_sign AS a ON a.order_no = d.order_no
		AND a.handle_by = #{riderNo}


) AS c,
 (
	SELECT
		count(DISTINCT a.order_no) AS 'delay_day_num'
	FROM
		t_handle_delay AS a
	INNER JOIN t_handle_rider_details AS b ON FROM_UNIXTIME(b.created_time, '%Y%m%d') =  #{dateFormat}
	AND a.order_no = b.order_no
	AND a.handle_by =  #{riderNo}
	AND FROM_UNIXTIME(a.created_time, '%Y%m%d') =  #{dateFormat}
	INNER JOIN t_handle_rider AS c ON b.handle_no = c.handle_no
	AND c. STATUS = 1
) AS d



</select>

</mapper>