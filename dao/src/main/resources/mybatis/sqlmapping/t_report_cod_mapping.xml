<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nilo.dms.dao.WaybillCodDao">

    <resultMap id="ReportCodDo" type="com.nilo.dms.dao.dataobject.ReportCodDO">
        <result property="orderNo" column="order_no" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="merchantId" column="merchant_id" javaType="java.lang.Long"
                jdbcType="INTEGER"/>
        <result property="weight" column="weight" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="money" column="money" javaType="java.lang.Double"
                jdbcType="DOUBLE"/>
        <result property="rider" column="name" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="orderPlatform" column="order_platform" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
         <result property="payType" column="payment_method" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="createTime" column="created_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="signTime" column="updated_time" javaType="java.lang.Integer"
                jdbcType="INTEGER"/>
        <result property="signName" column="sign_name" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
        <result property="phone" column="phone" javaType="java.lang.String"
                jdbcType="VARCHAR"/>
    </resultMap>

    <select id="queryReportCod" resultMap="ReportCodDo">


        SELECT a.order_no,a.merchant_id,a.order_platform,a.created_time, a.updated_time, a.weight, c.name, e.payment_method, f.name sign_name, f.contact_number phone, g.price_amount money

        FROM t_waybill a

        INNER JOIN t_waybill_task b

        on a.order_no = b.order_no

        INNER JOIN t_waybill_receiver f

        on a.order_no = f.order_no

        INNER JOIN t_sys_user_info c

        on b.handled_by=c.id

        LEFT JOIN t_waybill_payment_order_waybill d

        on a.order_no=d.waybill_order_no

        LEFT JOIN t_waybill_payment_record e

        on d.payment_order_id = e.third_pay_sn

        LEFT JOIN t_waybill_payment_order g

        on d.payment_order_id = e.id

        WHERE a.merchant_id=#{merchantId} AND is_cod = 1

        <if test="orderNo !=null  and orderNo !='' ">
            AND
            a.order_no = #{orderNo}
        </if>

        <if test="rider !=null  and rider !='' ">
            AND
            c.name = #{rider}
        </if>

        <if test="eTime_creat !=null and sTime_creat !=null and  eTime_creat != '' and sTime_creat != ''">
            <!--AND a.order_no LIKE CONCAT( CONCAT('%',#{orderNo}),'%')-->
            AND
            (a.created_time<![CDATA[<]]>#{eTime_creat} AND a.created_time>#{sTime_creat})
        </if>
        <if test="sTime_sign !=null and eTime_sign !=null and  sTime_sign != '' and eTime_sign != ''">
            <!--AND a.order_no LIKE CONCAT( CONCAT('%',#{orderNo}),'%')-->
            AND
            (a.updated_time<![CDATA[<]]>#{eTime_sign} AND a.updated_time>#{sTime_sign})
        </if>

        <if test="payType != null and payType != ''">
            AND
            e.payment_method = #{payType}
        </if>

        <if test="orderPlatform != null and orderPlatform != ''">
            AND
            a.order_platform = #{orderPlatform}
        </if>

        order by a.created_time desc

        limit #{offset} , #{limit}

    </select>


    <select id="queryReportCodCount" resultType="java.lang.Integer">

        SELECT

        count(*)

        FROM t_waybill a

        INNER JOIN t_waybill_task b

        on a.order_no = b.order_no

        INNER JOIN t_waybill_receiver f

        on a.order_no = f.order_no

        INNER JOIN t_sys_user_info c

        on b.handled_by=c.id

        LEFT JOIN t_waybill_payment_order_waybill d

        on a.order_no=d.waybill_order_no

        LEFT JOIN t_waybill_payment_record e

        on d.payment_order_id = e.third_pay_sn

        LEFT JOIN t_waybill_payment_order g

        on d.payment_order_id = e.id

        WHERE a.merchant_id=#{merchantId} AND is_cod = 1

        <if test="orderNo !=null  and orderNo !='' ">
            AND
            a.order_no = #{orderNo}
        </if>

        <if test="rider !=null  and rider !='' ">
            AND
            c.name = #{rider}
        </if>

        <if test="createTime !=null and createTime !=null and  createTime != '' and createTime != ''">
            <!--AND a.order_no LIKE CONCAT( CONCAT('%',#{orderNo}),'%')-->
            AND
            (a.created_time<![CDATA[<]]>#{createTime} AND a.created_time>#{createTime})
        </if>

        <if test="payType != null and payType != ''">
            AND
            e.payment_method = #{payType}
        </if>

    </select>
</mapper>