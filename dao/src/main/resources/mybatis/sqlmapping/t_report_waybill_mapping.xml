<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nilo.dms.dao.ReportWaybillDao">

    <!-- 实体bean与数据字段对应关系 -->
    <resultMap id="waybillMap" type="com.nilo.dms.dao.dataobject.ReportWaybillDO">
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="order_no" jdbcType="VARCHAR" property="orderNo" />
        <result column="order_type" jdbcType="VARCHAR" property="orderType" />
        <result column="reference_no" jdbcType="VARCHAR" property="referenceNo" />
        <result column="order_time" jdbcType="BIGINT" property="orderTime" />
        <result column="order_status" jdbcType="INTEGER" property="orderStatus" />
        <result column="order_created_time" jdbcType="INTEGER" property="orderCreatedTime" />
        <result column="first_arrive_time" jdbcType="INTEGER" property="firstArriveTime" />
        <result column="first_arrive_network_id" jdbcType="INTEGER" property="firstArriveNetworkId" />
        <result column="first_arrive_network_name" jdbcType="VARCHAR" property="firstArriveNetworkName" />
        <result column="last_deliver_time" jdbcType="INTEGER" property="lastDeliverTime" />
        <result column="last_deliver_network_id" jdbcType="INTEGER" property="lastDeliverNetworkId" />
        <result column="last_deliver_network_name" jdbcType="VARCHAR" property="lastDeliverNetworkName" />
        <result column="last_deliver_express_code" jdbcType="VARCHAR" property="lastDeliverExpressCode" />
        <result column="sign_time" jdbcType="INTEGER" property="signTime" />
        <result column="sign_handle_by_id" jdbcType="BIGINT" property="signHandleById" />
        <result column="sign_handle_by_name" jdbcType="VARCHAR" property="signHandleByName" />
        <result column="sign_network_id" jdbcType="INTEGER" property="signNetworkId" />
        <result column="sign_network_name" jdbcType="VARCHAR" property="signNetworkName" />
        <result column="created_time" jdbcType="INTEGER" property="createdTime" />
        <result column="sign_outsource_name" jdbcType="VARCHAR" property="signOutsourceName" />
        <result column="sign_outsource_code" jdbcType="VARCHAR" property="signOutsourceCode" />
        <result column="last_deliver_rider_id" jdbcType="BIGINT" property="lastDeliverRiderId" />
        <result column="last_deliver_rider_name" jdbcType="VARCHAR" property="lastDeliverRiderName" />
        <result column="updated_time" jdbcType="INTEGER" property="updatedTime" />
        <result column="last_deliver_outsource_name" jdbcType="VARCHAR" property="lastDeliverOutsourceName" />
    </resultMap>

    <sql id="Base_Column_List">
        id, order_no, order_type, reference_no, order_time, order_status, order_created_time,
        first_arrive_time, first_arrive_network_id, first_arrive_network_name, last_deliver_time,
        last_deliver_network_id, last_deliver_network_name, last_deliver_express_code, sign_time, sign_handle_by_id,
        sign_handle_by_name, sign_network_id, sign_network_name, created_time, updated_time
    </sql>

    <select id="queryWaybillReport" resultMap="waybillMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM
        t_report_waybill
        WHERE 1
        <if test="orderNo !=null and orderNo !='' ">
            and order_no LIKE CONCAT( CONCAT('%',#{orderNo}),'%')
        </if>
        <if test="referenceNo !=null and referenceNo !='' ">
            and reference_no LIKE CONCAT( CONCAT('%',#{referenceNo}),'%')
        </if>
        <if test="firstArriveNetworkId !=null and firstArriveNetworkId !='' ">
            and first_arrive_network_id = #{firstArriveNetworkId}
        </if>
        <if test="lastDeliverNetworkId !=null and lastDeliverNetworkId !='' ">
            and last_deliver_network_id = #{lastDeliverNetworkId}
        </if>
        <if test="lastDeliverExpressCode !=null and lastDeliverExpressCode !='' ">
            and last_deliver_express_code = #{lastDeliverExpressCode}
        </if>
        <if test="signHandleById !=null">
            and sign_handle_by_id = #{signHandleById}
        </if>
        <if test="signHandleByName !=null and signHandleByName !='' ">
            and sign_handle_by_name = #{signHandleByName}
        </if>
        <if test="signNetworkId !=null and signNetworkId !='' ">
            and sign_network_id = #{signNetworkId}
        </if>
        <if test="lastDeliverRiderId !=null">
            and last_deliver_rider_id = #{lastDeliverRiderId}
        </if>
        <if test="signOutsourceCode !=null and signOutsourceCode != ''">
            and sign_outsource_code = #{signOutsourceCode}
        </if>

        <if test="fromCreatedTime !=null ">and created_time >= #{fromCreatedTime}</if>
        <if test="toCreatedTime !=null ">and  <![CDATA[ created_time <= #{toCreatedTime} ]]></if>

        <if test="fromOrderTime !=null ">and order_time >= #{fromOrderTime}</if>
        <if test="toOrderTime !=null ">and  <![CDATA[ order_time <= #{toOrderTime} ]]></if>

        <if test="fromOrderCreatedTime !=null ">and order_created_time >= #{fromOrderCreatedTime}</if>
        <if test="toOrderCreatedTime !=null ">and  <![CDATA[ order_created_time <= #{toOrderCreatedTime} ]]></if>

        <if test="fromFirstArriveTime !=null ">and first_arrive_time >= #{fromFirstArriveTime}</if>
        <if test="toFirstArriveTime !=null ">and  <![CDATA[ first_arrive_time <= #{toFirstArriveTime} ]]></if>

        <if test="fromLastDeliverTime !=null ">and last_deliver_time >= #{fromLastDeliverTime}</if>
        <if test="toLastDeliverTime !=null ">and  <![CDATA[ last_deliver_time <= #{toLastDeliverTime} ]]></if>

        <if test="fromSignTime !=null ">and sign_time >= #{fromSignTime}</if>
        <if test="toSignTime !=null ">and  <![CDATA[ sign_time <= #{toSignTime} ]]></if>
        <if test="orderStatus != null">
            and order_status = #{orderStatus}
        </if>
        order by created_time desc
        limit #{offset} , #{limit}
    </select>
    
    <select id="queryWaybillReportFormWaybill" resultMap="waybillMap">
        SELECT 
        order_no,order_type,reference_no,order_time ,status order_status, created_time order_created_time ,updated_time
        FROM
        t_waybill
        WHERE order_no = #{order_no} 
    </select>
    
    <select id="queryWaybillReportByUpdateTime" resultMap="waybillMap">
        SELECT
        order_no,order_type,reference_no,order_time ,order_status, created_time order_created_time ,updated_time
        FROM
        t_waybill
        WHERE 1
        <if test="toCreatedTime !=null ">
            and  <![CDATA[ updated_time > #{updated_time} ]]>
        </if>
    </select>
    
    <select id="queryWaybillReportByOrderNo" resultMap="waybillMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM
        t_report_waybill
        WHERE  order_no = #{orderNo} 
    </select>
    
    <select id="queryWaybillReportMaxUpdatedTime" resultType="java.lang.Long">
        SELECT  ifnull(max(updated_time),1527928279) from t_report_waybill 
    </select>
    <select id="queryWaybillReportMaxCreatTime" resultType="java.lang.Long">
        SELECT  ifnull(max(created_time),1527928279) from t_report_waybill 
    </select>
    <select id="queryWaybillArriveLog" resultMap="waybillMap">
        SELECT t.opt_time first_arrive_time ,t.order_no order_no ,t.network_id first_arrive_network_id   from t_waybill_log_arrive t WHERE id = (SELECT min(id) from t_waybill_log_arrive where order_no = #{orderNo})
    </select>
    <select id="queryWaybillDeliverExpressLog" resultMap="waybillMap">
        SELECT updated_time last_deliver_time,network_code last_deliver_network_id,third_express_code last_deliver_express_code from t_handle_third_express t2 where id = (SELECT max(t1.id) from t_handle_third_express_details t,t_handle_third_express t1 where t.third_handle_no = t1.handle_no and t.`status` =1 AND t.order_no = #{orderNo})
    </select>
    <select id="queryWaybillDeliverRiderLog" resultMap="waybillMap">
        SELECT updated_time last_deliver_time,network_id last_deliver_network_id , rider last_deliver_rider_id from t_handle_rider t2 where id = (SELECT max(t1.id) from t_handle_rider_details t,t_handle_rider t1 where t.handle_no = t1.handle_no and t.`status` =1 AND t.order_no = #{orderNo})
    </select>
    <select id="queryWaybillDeliverStationLog" resultMap="waybillMap">
        SELECT updated_time last_deliver_time,network_code last_deliver_network_id,third_express_code last_deliver_express_code from t_handle_third_express t2 where id = (SELECT max(t1.id) from t_handle_third_express_details t,t_handle_third_express t1 where t.third_handle_no = t1.handle_no and t.`status` =1 AND t.order_no = #{parentNo})
    </select>
    <select id="queryWaybillSignLog" resultMap="waybillMap">
        SELECT order_no ,handle_by sign_handle_by_id, created_time sign_time,network_code sign_network_id from t_handle_sign t where t.order_no = #{orderNo}
    </select>
    
    <!-- 动态更新语句 -->
    <update id="updateWaybillReport" parameterType="com.nilo.dms.dao.dataobject.ReportWaybillDO" statementType="PREPARED">
        update t_report_waybill
        <trim prefix="set" suffixOverrides="," suffix="where order_no=#{orderNo}">
            <if test="orderStatus != null ">
                order_status = #{orderStatus},
            </if>
            <if test="firstArriveTime != null ">
                first_arrive_time = #{firstArriveTime},
            </if>
            <if test="firstArriveNetworkId != null ">
                first_arrive_network_id = #{firstArriveNetworkId},
            </if>
            <if test="firstArriveNetworkName != null">
                first_arrive_network_name = #{firstArriveNetworkName},
            </if>
            <if test="lastDeliverTime != null">
                last_deliver_time = #{lastDeliverTime},
            </if>
            <if test="lastDeliverNetworkId != null">
                last_deliver_network_id = #{lastDeliverNetworkId},
            </if>
            <if test="lastDeliverNetworkName != null">
                last_deliver_network_name = #{lastDeliverNetworkName},
            </if>
            <if test="lastDeliverExpressCode != null">
                last_deliver_express_code = #{lastDeliverExpressCode},
            </if>
            <if test="signTime != null">
                sign_time = #{signTime},
            </if>
            <if test="signHandleById != null">
                sign_handle_by_id = #{signHandleById},
            </if>
            <if test="signHandleByName != null">
                sign_handle_by_name = #{signHandleByName},
            </if>
            <if test="signNetworkId != null">
                sign_network_id = #{signNetworkId},
            </if>
            <if test="signNetworkName != null">
                sign_network_name = #{signNetworkName},
            </if>
            <if test="signOutsourceName != null">
                sign_outsource_name = #{signOutsourceName},
            </if>
            <if test="signOutsourceCode != null">
                sign_outsource_code = #{signOutsourceCode},
            </if>
            <if test="lastDeliverRiderId != null">
                last_deliver_rider_id = #{lastDeliverRiderId},
            </if>
            <if test="lastDeliverRiderName != null">
                last_deliver_rider_name = #{lastDeliverRiderName},
            </if>
            <if test="lastDeliverOutsourceCode != null">
                last_deliver_outsource_name = #{lastDeliverOutsourceCode},
            </if>
        updated_time = #{updatedTime}
    </trim>
    </update>
    
     <!-- 插入语句 -->
    <insert id="insertReportWaybill" parameterType="com.nilo.dms.dao.dataobject.ReportWaybillDO" statementType="PREPARED"
            useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO t_report_waybill
        ( order_no,order_type,reference_no,order_time ,order_status, order_created_time,first_arrive_time,first_arrive_network_id, first_arrive_network_name,last_deliver_time,last_deliver_network_id, last_deliver_network_name,last_deliver_express_code,sign_time, sign_handle_by_id ,sign_handle_by_name,sign_network_id,sign_network_name,sign_outsource_name,sign_outsource_code,last_deliver_rider_id,last_deliver_rider_name,created_time,updated_time,last_deliver_outsource_name)
        VALUES
        ( #{orderNo},#{orderType},#{referenceNo},#{orderTime},#{orderStatus},#{orderCreatedTime},#{firstArriveTime},#{firstArriveNetworkId}, #{firstArriveNetworkName}, #{lastDeliverTime},#{lastDeliverNetworkId},#{lastDeliverNetworkName}, #{lastDeliverExpressCode},#{signTime},#{signHandleById},#{signHandleByName},#{signNetworkId},#{signNetworkName},#{signOutsourceName},#{signOutsourceCode},#{lastDeliverRiderId},#{lastDeliverRiderName}, UNIX_TIMESTAMP(NOW()),#{updatedTime},#{lastDeliverOutsourceName})
    </insert>

    <select id="queryCountBy" resultType="java.lang.Long">
        SELECT
        count(1)
        FROM
        t_report_waybill
        WHERE 1
        <if test="orderNo !=null and orderNo !='' ">
            and order_no LIKE CONCAT( CONCAT('%',#{orderNo}),'%')
        </if>
        <if test="referenceNo !=null and referenceNo !='' ">
            and reference_no LIKE CONCAT( CONCAT('%',#{referenceNo}),'%')
        </if>
        <if test="firstArriveNetworkId !=null and firstArriveNetworkId !='' ">
            and first_arrive_network_id = #{firstArriveNetworkId}
        </if>
        <if test="lastDeliverNetworkId !=null and lastDeliverNetworkId !='' ">
            and last_deliver_network_id = #{lastDeliverNetworkId}
        </if>
        <if test="lastDeliverExpressCode !=null and lastDeliverExpressCode !='' ">
            and last_deliver_express_code = #{lastDeliverExpressCode}
        </if>
        <if test="signHandleById !=null">
            and sign_handle_by_id = #{signHandleById}
        </if>
        <if test="signHandleByName !=null and signHandleByName !='' ">
            and sign_handle_by_name = #{signHandleByName}
        </if>
        <if test="signNetworkId !=null and signNetworkId !='' ">
            and sign_network_id = #{signNetworkId}
        </if>
        <if test="lastDeliverRiderId !=null">
            and last_deliver_rider_id = #{lastDeliverRiderId}
        </if>
        <if test="signOutsourceCode !=null and signOutsourceCode != ''">
            and sign_outsource_code = #{signOutsourceCode}
        </if>
        <if test="fromCreatedTime !=null ">and created_time >= #{fromCreatedTime}</if>
        <if test="toCreatedTime !=null ">and  <![CDATA[ created_time <= #{toCreatedTime} ]]></if>

        <if test="fromOrderTime !=null ">and order_time >= #{fromOrderTime}</if>
        <if test="toOrderTime !=null ">and  <![CDATA[ order_time <= #{toOrderTime} ]]></if>

        <if test="fromOrderCreatedTime !=null ">and order_created_time >= #{fromOrderCreatedTime}</if>
        <if test="toOrderCreatedTime !=null ">and  <![CDATA[ order_created_time <= #{toOrderCreatedTime} ]]></if>

        <if test="fromFirstArriveTime !=null ">and first_arrive_time >= #{fromFirstArriveTime}</if>
        <if test="toFirstArriveTime !=null ">and  <![CDATA[ first_arrive_time <= #{toFirstArriveTime} ]]></if>

        <if test="fromLastDeliverTime !=null ">and last_deliver_time >= #{fromLastDeliverTime}</if>
        <if test="toLastDeliverTime !=null ">and  <![CDATA[ last_deliver_time <= #{toLastDeliverTime} ]]></if>

        <if test="fromSignTime !=null ">and sign_time >= #{fromSignTime}</if>
        <if test="toSignTime !=null ">and  <![CDATA[ sign_time <= #{toSignTime} ]]></if>

        <if test="orderStatus != null">
            and order_status = #{orderStatus}
        </if>
    </select>
</mapper>